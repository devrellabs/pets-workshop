##################################################################################################################
# Build and deploy via Azure Pipelines
# Refer to https://dev.azure.com/PUnlimited/PetsWorkshop/_boards/board/t/PetsWorkshop%20Team/Stories?workitem=642
# Dave Burnison 2025-11-05
##################################################################################################################

trigger:
  branches:
    include:
      - main

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  pythonVersions: '["3.12", "3.13", "3.14"]'
  azureServiceConnection: 'Pets Workshop'
  location: 'eastus'

###################################################################
# CI Stage                                                        #
###################################################################
stages:
- stage: CI
  displayName: CI
  jobs:
  - job: Build
    displayName: 'Build the app'
    
    steps:
    - checkout: self
      displayName: 'Checkout code'
    
    - script: echo "Task Succeeded"
      displayName: 'Build'

  - job: TestMatrix
    displayName: 'Test with Multiple Python Versions'
    strategy:
      matrix:
        Python312:
          pythonVersion: '3.12'
        Python313:
          pythonVersion: '3.13'
        Python314:
          pythonVersion: '3.14'
    
    steps:
    - checkout: self
      displayName: 'Checkout code'
    
    - task: UsePythonVersion@0
      displayName: 'Set up Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r server/requirements.txt
        pip install pytest pytest-cov
      displayName: 'Install dependencies'
    
    - script: |
        cd server
        python -m pytest test_app.py -v --tb=short --junitxml=test-results.xml --cov=app --cov-report=term-missing --cov-report=xml
      displayName: 'Run tests with pytest'
    
    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: 'server/test-results.xml'
        testRunTitle: 'Python $(pythonVersion) Tests'
        failTaskOnFailedTests: true
    
    - task: PublishCodeCoverageResults@2
      displayName: 'Upload coverage reports'
      condition: eq(variables['pythonVersion'], '3.12')
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: 'server/coverage.xml'
        reportDirectory: 'server/htmlcov'
        failIfCoverageEmpty: false

###################################################################
# Dev Stage                                                       #
###################################################################
- stage: Dev
  displayName: Dev
  dependsOn: CI
  variables:
    slot: Dev
    environmentName: Dev

  jobs:
  - deployment: DeployWeb
    displayName: Deploy and test
    # creates an environment if it doesn't exist
    environment: 'Dev'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: AzureCLI@2
            displayName: 'Deploy Bicep template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                objectId=$(az ad sp show --id $servicePrincipalId --query id -o tsv)
                az deployment sub create \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/infra/main.bicep \
                  --name $(environmentName)-deployment \
                  --parameters \
                    environmentName=$(environmentName) \
                    location=$(location) \
                    principalId=$objectId \
                    principalType=ServicePrincipal \
                    clientExists=false \
                    serverExists=false

###################################################################
# QA Stage                                                        #
###################################################################
- stage: QA
  displayName: QA
  dependsOn: Dev
  variables:
    slot: QA
    environmentName: QA

  jobs:
  - deployment: DeployWeb
    displayName: Deploy and test
    # creates an environment if it doesn't exist
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: AzureCLI@2
            displayName: 'Deploy Bicep template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                objectId=$(az ad sp show --id $servicePrincipalId --query id -o tsv)
                az deployment sub create \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/infra/main.bicep \
                  --name $(environmentName)-deployment \
                  --parameters \
                    environmentName=$(environmentName) \
                    location=$(location) \
                    principalId=$objectId \
                    principalType=ServicePrincipal \
                    clientExists=false \
                    serverExists=false

###################################################################
# Production  Stage                                               #
###################################################################
- stage: Production
  displayName: Production
  dependsOn: QA
  variables:
    slot: Production
    environmentName: Production

  jobs:
  - deployment: DeployWeb
    displayName: Deploy
    # creates an environment if it doesn't exist
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: AzureCLI@2
            displayName: 'Deploy Bicep template'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                objectId=$(az ad sp show --id $servicePrincipalId --query id -o tsv)
                az deployment sub create \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/infra/main.bicep \
                  --name $(environmentName)-deployment \
                  --parameters \
                    environmentName=$(environmentName) \
                    location=$(location) \
                    principalId=$objectId \
                    principalType=ServicePrincipal \
                    clientExists=false \
                    serverExists=false

